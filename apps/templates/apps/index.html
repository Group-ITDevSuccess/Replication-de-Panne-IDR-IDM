{% extends 'base.html' %}
{% block title %}Home{% endblock %}
{% block content %}
    <main class="container-fluid mt-4">
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible fade show"
                     role="alert">
                    <strong>{{ message.tags|title }}!</strong> {{ message.message }}
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
            {% endfor %}
        {% endif %}
        <div class="mb-2">
            <button class="btn btn-secondary" id="download-xlsx"><i class="fas fa-file-excel"></i></button>
            <button class="btn btn-secondary" id="download-pdf"><i class="fas fa-file-pdf"></i></button>
            <button class="btn btn-secondary" id="print-table"><i class="fas fa-print"></i></button>
            <button class="btn btn-info" id="history-undo"><i class="fas fa-undo-alt"></i></button>
            <button class="btn btn-info" id="history-redo"><i class="fas fa-redo-alt"></i></button>
            <button type="button" class="btn btn-outline-warning" data-toggle="modal"
                    data-target="#listMachineModal"><i class="fas fa-list-alt"></i></button>
            <button type="button" class="btn btn-outline-warning" data-toggle="modal"
                    data-target="#addCompanyModal"><i class="fas fa-plus-circle"></i></button>
        </div>
        <div id="pannes"></div>

    </main>
{% endblock %}
{% block script %}

    {#    Note responsive : https://jsfiddle.net/3fLwej4u/#}
    {#    Tabulator : https://tabulator.info/#}
    {#    https://tabulator.info/docs/6.2/data#}
    <script type="text/javascript">
        function textareaPopup(cell, onRendered, success, cancel) {
          // Create a unique modal ID
          const modalId = `editCellModal-${cell.getData().uid}`;

          // Create the modal HTML structure
          const modalHtml = `
            <div class="modal fade" id="${modalId}" tabindex="-1" role="dialog" aria-labelledby="${modalId}Label" aria-hidden="true">
              <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="${modalId}Label">Ajout ou Modification</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                    </button>
                  </div>
                  <div class="modal-body">
                    <textarea id="cellValue" class="form-control"></textarea>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Fermer</button>
                    <button type="button" class="btn btn-primary" id="saveChanges">Sauvegarder</button>
                  </div>
                </div>
              </div>
            </div>
          `;

          let textArea;

          // Ensure DOM is ready before manipulating (consider using vanilla JavaScript alternatives if not using jQuery)
          $(document).ready(function() {
            // Append the modal HTML to the body
            $('body').append(modalHtml);

            // Get the newly created modal element
            const modalElement = document.getElementById(modalId);

            // Show the modal using Bootstrap's data attributes
            $(modalElement).modal('show');

            // Set the textarea value
            textArea = document.getElementById("cellValue");
            textArea.value = cell.getValue();

            // Initialize Summernote on the textarea (consider using a different rich text editor if needed)
            $(textArea).summernote({
              placeholder: 'Enter text here...',
              tabsize: 1,
              height: 150,
              codemirror: { // codemirror options
                    theme: 'monokai'
                },

              disableResizeEditor: true, // Disable editor resize
              disableDragAndDrop: true, // Disable drag and drop

            });

            // Save changes button click event handler
            const saveChangesBtn = document.getElementById("saveChanges");
            saveChangesBtn.addEventListener("click", () => {
              const newValue = $(textArea).summernote('code');
              success(newValue);
              $(modalElement).modal('hide');
            });

            // Modal hide event listener - destroy Summernote and call cancel
            $(modalElement).on('hide.bs.modal', () => {
              $(textArea).summernote('destroy');
              cancel();

              // Remove the modal from the DOM to prevent memory leaks
              $(`#${modalId}`).remove();
            });
          });
          return textArea;
        }

        let iconDelete = function (cell, formatterParams) { //plain text value
            return "<i class='fa fa-trash-can'></i>";
        };


        let tableMachine = new DataTable('#tableMachine', {
            info: false,
            filter: false,
            ajax: '{% url 'apps:get_all_machines_in_table' %}',
            columns: [
                {data: null, width: '5%'},
                {data: 'matriculate'},
                {data: 'model'},
            ],
            select: true,
            createdRow: function (row, data, dataIndex) {
                tableMachine.rows().every(function (idx) {
                    $(this.node()).find('td').eq(0).html(idx + 1);
                });
            },
        });


        let tickCrossEditor = function (cell, onRendered, success, cancel) {
            // Create the checkbox element
            let checkbox = document.createElement("input");
            checkbox.type = "checkbox";

            // Get the current value of the cell
            let currentValue = cell.getValue();

            // Check if both matriculate and model fields are not empty
            let canTick = cell.getRow().getData().matriculate && cell.getRow().getData().company_name;

            // Set the checkbox state based on the current value and allowed state
            checkbox.checked = currentValue === true && canTick;
            checkbox.disabled = !canTick;

            // Handle checkbox change event
            checkbox.addEventListener("change", function () {
                if (canTick) {
                    success(checkbox.checked);
                } else {
                    // If not allowed to tick, reset the checkbox and show an alert
                    checkbox.checked = false;
                    alert("Please fill in 'Matriculate' and 'Model' fields before marking.");
                }
            });

            onRendered(function () {
                cell.getElement().appendChild(checkbox);
            });

            return checkbox;
        };

        let headerPopupFormatter = function (e, column, onRendered) {
            let container = document.createElement("div");

            let label = document.createElement("label");
            label.innerHTML = "Filtre Colonne:";
            label.style.display = "block";
            label.style.fontSize = ".7em";

            let input = document.createElement("input");
            input.placeholder = "Chercher ...";
            input.value = column.getHeaderFilterValue() || "";

            input.addEventListener("keyup", (e) => {
                column.setHeaderFilterValue(input.value);
            });

            container.appendChild(label);
            container.appendChild(input);

            return container;
        }

        let emptyHeaderFilter = function () {
            return document.createElement("div");
        }

        let addRow = function () {
            let newRowData = {};
            table.addRow(newRowData, false);
        }

        function sendSelectedRows() {
            let editedCells = table.getEditedCells();
            let selectedRowsData = editedCells.filter(cell => {
                let rowData = cell.getRow().getData();
                return cell.getColumn().getField() === "tickCross" && rowData.tickCross === true;
            }).map(cell => cell.getRow().getData());
            console.log(selectedRowsData)
            fetch("", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(selectedRowsData)
            }).then(response => response.json())
                .then(data => {
                    // Handle the response from the backend (success/failure)
                    console.log("AJAX POST response:", data);
                })
                .catch(error => {
                    console.error("AJAX POST error:", error);
                });
        }

        function uniqueCellFormatter(cell) {
            let data = table.getData(); // Get all table data
            let value = cell.getValue();

            // Check if the value is unique
            let isUnique = data.every(row => row.matriculate !== value || row === cell.getRow());

            if (!isUnique) {
                // Set a red border if the value is not unique
                return {
                    border: "2px solid red"
                };
            }

            // No border by default
            return {};
        }


        function reloadPage() {
            window.reload()
        }

        function formatDate(dateString) {
            if (dateString && dateString.trim() !== '') { // Vérifiez si dateString est une chaîne non vide
                const [day, month, year] = dateString.split('/');
                // Si votre date est au format DD/MM/YYYY, vous pouvez la reformater en YYYY-MM-DD
                return `${year}-${month}-${day}`;
            }
            return null; // Renvoyer null si la date est vide ou non valide
        }

        function calculImmo(cell) {
            const rowData = cell.getRow().getData();


            // Convertir la date dans le bon format
            const formattedStartDate = formatDate(rowData.start);

            if (formattedStartDate) {
                const startDate = new Date(formattedStartDate);
                if (isNaN(startDate.getTime())) {
                    return "";
                }

                // Calculer la différence en jours
                const today = new Date();
                const diffInMs = today.getTime() - startDate.getTime();

                return Math.floor(diffInMs / (1000 * 60 * 60 * 24));
            }
            return ''

        }

        function calculImmoReel(cell) {
            const rowData = cell.getRow().getData();

            const formattedStartDate = formatDate(rowData.start);
            const formattedEndDate = formatDate(rowData.leave);

            if (formattedStartDate && formattedEndDate) {
                const startDate = new Date(formattedStartDate);
                const endDate = new Date(formattedEndDate);
                if (isNaN(startDate.getTime())) {
                    return "";
                }
                if (isNaN(endDate.getTime())) {
                    return "";
                }

                const diffInMs = endDate.getTime() - startDate.getTime();

                return Math.floor(diffInMs / (1000 * 60 * 60 * 24)) + 1;
            }
            return ''

        }

        function stateLine(cell, formatterParams) {
            let rowData = cell.getRow().getData();
            let rowStart = rowData.start;
            let rowLeave = rowData.leave;
                
            if (rowStart) {
                if (rowLeave) {
                    return 'Active';
                } else {
                    return 'Inactive';
                }
            } else {
                return '';
            }

        }

        let table = new Tabulator("#pannes", {
            ajaxURL: '{{ get_breakdown_url }}',
            ajaxContentType: "json",
            layout: "fitDataFill",
            printAsHtml: true,
            printHeader: "<h1>Example Table Header<h1>",
            printFooter: "<h2>Example Table Footer<h2>",
            footerElement: `<button type='button' class='btn btn-success btn-sm mr-2' id="openModalBtn"><i class='fas fa-map-location'></i></button><button type='button' class='btn btn-warning btn-sm mr-2' id='reload-table' onClick="reloadPage()"><i class='fas fa-sync-alt'></i></button>`,
            tooltipsHeader: true,
            rowFormatter: function (row) {
                const rowData = row.getData();
                const state = rowData.state;

                // Apply CSS classes based on the state value
                if (state === 'Active') {
                    row.getElement().classList.add('active-row'); // Add 'active-row' class
                } else if (state === 'Inactive') {
                    row.getElement().classList.add('inactive-row'); // Add 'inactive-row' class
                }
            },
            rowHeader: {
                title: `<button type='button' class='btn btn-primary btn-sm mr-2' id='add-row' onclick="addRow()"><i class='fas fa-plus'></i></button>`,
                headerSort: false,
                resizable: false,
                minWidth: 30,
                width: 35,
                frozen: true,
                rowHandle: true,
                editor: false,
                formatter: "handle",
            },
            movableRows: true,
            history: true,
            success: function (data) {
                // Access breakdowns data from 'data' key (assuming the backend sends an object with a 'data' key)
                const breakdowns = data.data;
                table.setData(breakdowns);  // Set data to the table using setData method
            },
            selectableRangeColumns: true,
            selectableRangeRows: true,
            headerSortClickElement: 'icon',
            selectableRangeClearCells: true,
            pagination: "local",
            paginationSize: 10,
            paginationSizeSelector: [20, 30, 40],
            paginationCounter: "rows",
            renderHorizontal: "virtual",
            resizableColumnFit: true,
            resizableRowGuide: true,
            resizableColumnGuide: true,
            editTriggerEvent: "dblclick",
            printRowRange: "selected",
            initialSort: [
                {column: "matriculate", dir: "asc"},
            ],
            placeholder: "Aucun Donnée",
            placeholderHeaderFilter: 'Aucun Donnée Coorespondant',
            headerSort: true,
            columnDefaults: {
                tooltip: true,
                headerHozAlign: "center",
                editor: "input",
                resizable: "header",
            },
            columns: [
                {
                    title: "<code>*</code>",
                    frozen: true,
                    resizable: false,
                    hozAlign: "center",
                    formatter: "tickCross",
                    editor: tickCrossEditor,
                    headerSort: false,
                    cellEdited: function (cell) {
                        let edited = cell.isEdited();
                        if (edited) {
                            let conf = confirm("Est-vous sûr de vouloir enregistrer ce ligne ?")
                            if (conf) {
                                const rowData = cell.getRow().getData();
                                console.log(table.getEditedCells())
                                if (rowData.uid) {
                                    // Update existing breakdown using apps:update_line
                                    fetch("{% url 'apps:update_line' %}", {
                                        method: "POST",
                                        headers: {
                                            "Content-Type": "application/json"
                                        },
                                        body: JSON.stringify(rowData)
                                    })
                                        .then(response => response.json())
                                        .then(data => {
                                            if (data.success) {
                                                cell.getRow().update(rowData);
                                            }
                                        })
                                        .catch(error => {
                                            console.error("Error updating breakdown:", error);
                                        });
                                } else {
                                    fetch("{% url 'apps:post_line' %}", {
                                        method: "POST",
                                        headers: {
                                            "Content-Type": "application/json"
                                        },
                                        body: JSON.stringify(rowData)
                                    })
                                        .then(response => {
                                            if (response.status === 409) {
                                                return response.json().then(data => {
                                                    alert(data.error);
                                                    location.reload();
                                                });
                                            }
                                            return response.json(); // Parser la réponse JSON pour les requêtes réussies
                                        })

                                }
                            }
                        }
                    }
                },
                {
                    title: "N°",
                    resizable: false,
                    formatter: "rownum",
                    hozAlign: "center",
                    width: 40,
                    editor: false,
                    frozen: true,
                    headerSort: false,
                },
                {
                    title: "<code>*</code> Société",
                    field: "company_name",
                    editor: "list",
                    width: 100,
                    validator: "required",
                    frozen: true,
                    editorParams: {
                        sort: "asc",
                        valuesURL: "{% url 'apps:get_all_companies' %}",
                        placeholderLoading: "Chargement...",

                    },
                },
                {
                    title: "<code>*</code> Immat ou N° série ",
                    field: "matriculate",
                    width: 125,
                    frozen: true,
                    editor: "list",
                    editorParams: {
                        placeholderEmpty: "Aucun Matricule",

                        sort: "asc",
                        valuesURL: "{% url 'apps:get_all_matriculate' %}",
                        placeholderLoading: "Chargement...",

                    },
                    headerPopupIcon: "<i class='fas fa-filter' title='Filter column'></i>",
                    headerFilter: emptyHeaderFilter,
                    headerPopup: headerPopupFormatter,
                    headerFilterFunc: "like",
                },

                {
                    title: "Modèle / Remorque",
                    field: "model",
                    editor: "input",
                    frozen: true,
                    width: 125,
                },
                {
                    title: "NOM DU CLIENT",
                    field: "client_name",
                    width: 150,
                    editor: "list",
                },
                {
                    title: "Localisation",
                    field: "localisation_name",
                    editor: "list",
                    validator: "required",
                    editorParams: {
                        placeholderEmpty: "Aucun Localisation",
                        autocomplete: "true", allowEmpty: true, listOnEmpty: true,
                        valuesURL: "{% url 'apps:gat_all_localisation' %}",
                        placeholderLoading: "Chargement...",

                        formatter: function (value, data, cell) {
                            if (value && value.label) {
                                return value.label;  // Access and return the label from the value object
                            } else {
                                return "";
                            }
                        }
                    },
                },
                {
                    title: "Début panne",
                    hozAlign: "right",
                    field: "start",
                    sorter: "date",
                    width: 125,
                    editor: "date",
                    editorParams: {
                        min: "01/01/2020", // the minimum allowed value for the date picker
                        max: "31/12/2024", // the maximum allowed value for the date picker
                        format: "dd/MM/yyyy", // the format of the date value stored in the cell
                        verticalNavigation: "table", //navigate cursor around table without changing the value
                        elementAttributes: {
                            title: "slide bar to choose option" // custom tooltip
                        }
                    }
                },
                {
                    title: "Demande rdv",
                    field: "appointment",
                    sorter: "date",
                    width: 125,
                    editor: "date",
                    hozAlign: "right",
                    editorParams: {
                        min: "01/01/2020", // the minimum allowed value for the date picker
                        max: "31/12/2024", // the maximum allowed value for the date picker
                        format: "dd/MM/yyyy", // the format of the date value stored in the cell
                        verticalNavigation: "table", //navigate cursor around table without changing the value
                        elementAttributes: {
                            title: "slide bar to choose option" // custom tooltip
                        }
                    }
                },
                {
                    title: "Entrée garage",
                    field: "enter",
                    sorter: "date",
                    hozAlign: "right",
                    width: 125,
                    editor: "date", editorParams: {
                        min: "01/01/2020", // the minimum allowed value for the date picker
                        max: "31/12/2024", // the maximum allowed value for the date picker
                        format: "dd/MM/yyyy", // the format of the date value stored in the cell
                        verticalNavigation: "table", //navigate cursor around table without changing the value
                        elementAttributes: {
                            title: "slide bar to choose option" // custom tooltip
                        }
                    }
                },
                {
                    title: "Nb Jours Immo",
                    width: 100,
                    field: 'immo',
                    editor: false,
                    hozAlign: "right",
                    formatter: calculImmo,
                },
                {
                    title: "N° OR (ordre de réparation)",
                    hozAlign: "left",
                    field: "order",
                    width: 100,
                    editor: "number",
                    editorParams: {
                        min: 0,
                        max: 100,
                        elementAttributes: {
                            maxlength: "10", //set the maximum character length of the input element to 10 characters
                        },
                        mask: "999",
                        selectContents: true,
                        verticalNavigation: "table", //up and down arrow keys navigate away from cell without changing value
                    }
                },

                {
                    title: "DEMANDE DE TRAVAUX",
                    field: "works",
                    editor: textareaPopup,
                    width: 250,
                    formatter: function (cell, formatterParams) {
                        // Get the value from the cell
                        const value = cell.getValue();

                        // Use DOMPurify to sanitize the HTML content (optional but recommended for security)
                        const cleanText = DOMPurify.sanitize(value);

                        // Create a temporary element to remove HTML tags
                        const tempElement = document.createElement('div');
                        tempElement.textContent = cleanText;

                        // Return the plain text content
                        return tempElement.textContent;
                    },
                    editorParams: {
                        selectContents: true,
                        verticalNavigation: "editor",
                        shiftEnterSubmit: true,
                        maskAutoFill: true,

                    },

                },
                {
                    title: "ETAT PIECES REF",
                    field: "stats",
                    formatter: "star",
                    hozAlign: "center",
                    width: 100,
                    editor: true
                },

                {
                    title: "Date de sortie du garage",
                    field: "leave",
                    editor: "date",
                    editorParams: {
                        min: "01/01/2020", // the minimum allowed value for the date picker
                        max: "31/12/2024",
                        format: "dd/MM/yyyy",
                        verticalNavigation: "table",
                        sorter: "date",
                        hozAlign: "center"
                    },
                    width: 125,
                    sorter: "date",
                    hozAlign: "center"
                },
                {
                    title: "Nb Jours Immo Réelle",
                    width: 100,
                    field: 'immo_reel',
                    editor: false,
                    hozAlign: "right",
                    formatter: calculImmoReel,
                },
                {
                    title: "Actif / Non Actif",
                    width: 100,
                    field: 'state',
                    editor: false,
                    hozAlign: "center",
                    formatter: stateLine,
                    formatterParams: { // Define properties for conditional formatting
                        activeBackgroundColor: "#90EE90", // Light green
                        inactiveBackgroundColor: "#FFCDD2" // Light red
                    }
                },

                {
                    title: "Date prévisionnelle de sortie garage",
                    field: "exit",
                    sorter: "date",
                    editor: "date",
                    editorParams: {
                        min: "01/01/2020", // the minimum allowed value for the date picker
                        max: "31/12/2024", // the maximum allowed value for the date picker
                        format: "dd/MM/yyyy", // the format of the date value stored in the cell
                        verticalNavigation: "table", //navigate cursor around table without changing the value
                        elementAttributes: {
                            title: "slide bar to choose option" // custom tooltip
                        }
                    },
                    width: 125,
                    hozAlign: "center"
                },
                {
                    formatter: iconDelete,
                    headerSort: false,
                    frozen: true,
                    resizable: false,
                    hozAlign: "center",
                    cellClick: function (e, cell) {
                        console.log(cell.getData().uid)
                        if (confirm("Est-vous sûr de vouloir supprimer ceci ?")) {

                            let breakdownId = cell.getData().uid;
                            if (breakdownId) {
                                fetch("{% url 'apps:delete_breakdown' %}", {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/x-www-form-urlencoded",
                                        "X-CSRFToken": "{{ csrf_token }}"
                                    },
                                    body: "breakdown_id=" + breakdownId
                                })
                                    .then(response => response.json())
                                    .then(data => {
                                        if (data.success) {
                                            table.deleteRow(cell.getRow());
                                        } else {
                                            console.error("Error deleting Breakdown:", data.error);
                                        }
                                    })
                                    .catch(error => {
                                        console.error("Error deleting Breakdown:", error);
                                    });
                            }

                            table.deleteRow(cell.getRow());
                        }
                    }
                }
            ],
        });

        document.getElementById("download-xlsx").addEventListener("click", function () {
            table.download("xlsx", "data.xlsx", {sheetName: "My Data"});
        });


        document.getElementById("print-table").addEventListener("click", function () {
            table.print(false, true);
        });

        //trigger download of data.pdf file
        document.getElementById("download-pdf").addEventListener("click", function () {
            table.download("pdf", "data.pdf", {
                orientation: "portrait", //set page orientation to portrait
                title: "Example Report", //add title to report
            });
        });


        table.on("rowMoved", function (row) {
            console.log("Row: " + row.getData().matriculate + " has been moved");
        });

        //undo button
        document.getElementById("history-undo").addEventListener("click", function () {
            table.undo();
        });

        //redo button
        document.getElementById("history-redo").addEventListener("click", function () {
            table.redo();
        });

        document.addEventListener('DOMContentLoaded', function () {
            // Gérer le clic sur le bouton pour ouvrir le modal
            document.getElementById('openModalBtn').addEventListener('click', function () {
                let myModal = new bootstrap.Modal(document.getElementById('chartModal'));
                myModal.show();


                fetch('{% url 'apps:get_all_breakdown' %}')
                    .then(response => response.json())
                    .then(data => {
                        console.log(data)
                        Highcharts.mapChart('container-map', {
                            chart: {
                                margin: 0
                            },

                            title: {
                                text: ''
                            },

                            subtitle: {
                                text: ''
                            },

                            navigation: {
                                buttonOptions: {
                                    align: 'left',
                                    theme: {
                                        stroke: '#e6e6e6'
                                    }
                                }
                            },

                            mapNavigation: {
                                enabled: true,
                                buttonOptions: {
                                    alignTo: 'spacingBox'
                                }
                            },

                            mapView: {
                                center: [46.3927, -18.6174],
                                zoom: 7
                            },

                            tooltip: {
                                pointFormat: '{point.name}'
                            },

                            legend: {
                                enabled: true,
                                title: {
                                    text: 'Map Engin en Pane'
                                },
                                align: 'left',
                                symbolWidth: 20,
                                symbolHeight: 20,
                                itemStyle: {
                                    textOutline: '1 1 1px rgba(255,255,255)'
                                },
                                backgroundColor: 'rgba(255,255,255,0.8)',
                                float: true,
                                borderColor: '#e6e6e6',
                                borderWidth: 1,
                                borderRadius: 2,
                                itemMarginBottom: 5
                            },

                            plotOptions: {
                                mappoint: {
                                    dataLabels: {
                                        enabled: false
                                    }
                                }
                            },
                            series: data
                        });
                    })
                    .catch(error => console.error('Erreur lors de la récupération des données :', error));
            });
        });


        window.addEventListener('resize', function () {
            table.redraw();
        });

    </script>
{% endblock %}