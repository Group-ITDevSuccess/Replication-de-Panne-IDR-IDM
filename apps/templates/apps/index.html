{% extends 'base.html' %}
{% load i18n %}
{% load humanize %}
{% block title %}Home{% endblock %}
{% block content %}
    <main class="container-fluid mt-4">
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible fade show"
                     role="alert">
                    <strong>{{ message.tags|title }}!</strong> {{ message.message }}
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
            {% endfor %}
        {% endif %}
        <div class="mb-2">
            <button class="btn btn-secondary" id="download-xlsx"><i class="fas fa-file-excel"></i></button>
            <button class="btn btn-secondary" id="download-pdf"><i class="fas fa-file-pdf"></i></button>
            <button class="btn btn-secondary" id="print-table"><i class="fas fa-print"></i></button>
            <button class="btn btn-info" id="history-undo"><i class="fas fa-undo-alt"></i></button>
            <button class="btn btn-info" id="history-redo"><i class="fas fa-redo-alt"></i></button>
            <button type="button" class="btn btn-outline-warning" data-toggle="modal"
                    data-target="#listMachineModal"><i class="fas fa-list-alt"></i></button>
            <button type="button" class="btn btn-outline-warning" data-toggle="modal"
                    data-target="#addCompanyModal"><i class="fas fa-plus-circle"></i></button>
        </div>
        <div id="pannes"></div>

    </main>
{% endblock %}
{% block script %}

    {#    Note responsive : https://jsfiddle.net/3fLwej4u/#}
    {#    Tabulator : https://tabulator.info/#}
    {#    https://tabulator.info/docs/6.2/data#}
    <script type="text/javascript">
        function textareaPopup(cell, onRendered, success, cancel) {
          const modalId = `editCellModal-${cell.getData().uid}`;

          const modalHtml = `
            <div class="modal fade" id="${modalId}" tabindex="-1" role="dialog" aria-labelledby="${modalId}Label" aria-hidden="true">
              <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="${modalId}Label">Ajout ou Modification</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                    </button>
                  </div>
                  <div class="modal-body">
                    <textarea id="cellValue" class="form-control"></textarea>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Fermer</button>
                    <button type="button" class="btn btn-primary" id="saveChanges">Sauvegarder</button>
                  </div>
                </div>
              </div>
            </div>
          `;

          let textArea;

            $('body').append(modalHtml);

            // Get the newly created modal element
            const modalElement = document.getElementById(modalId);

            // Show the modal using Bootstrap's data attributes
            $(modalElement).modal('show');

            // Set the textarea value
            textArea = document.getElementById("cellValue");
            textArea.value = cell.getValue();

            // Initialize Summernote on the textarea (consider using a different rich text editor if needed)
            $(textArea).summernote({
              placeholder: 'Enter text here...',
              tabsize: 0.5,
              height: 150,
              codemirror: { // codemirror options
                    theme: 'monokai'
                },

              disableResizeEditor: true, // Disable editor resize
              disableDragAndDrop: true, // Disable drag and drop

            });

            // Save changes button click event handler
            const saveChangesBtn = document.getElementById("saveChanges");
            saveChangesBtn.addEventListener("click", () => {
              const newValue = $(textArea).summernote('code');
              success(newValue);
              $(modalElement).modal('hide');
            });

            $(modalElement).on('hide.bs.modal', () => {
              $(textArea).summernote('destroy');
              cancel();

              // Remove the modal from the DOM to prevent memory leaks
              $(`#${modalId}`).remove();
            });
          return textArea;
        }

        let minMaxFilterEditor = function (cell, onRendered, success, cancel, editorParams) {

            let end;

            let container = document.createElement("span");

            //create and style inputs
            let start = document.createElement("input");
            start.setAttribute("type", "number");
            start.setAttribute("placeholder", "Min");
            start.setAttribute("min", 0);
            start.setAttribute("max", 100);
            start.style.padding = "4px";
            start.style.width = "50%";
            start.style.boxSizing = "border-box";

            start.value = cell.getValue();

            function buildValues() {
                success({
                    start: start.value,
                    end: end.value,
                });
            }

            function keypress(e) {
                if (e.keyCode == 13) {
                    buildValues();
                }

                if (e.keyCode == 27) {
                    cancel();
                }
            }

            end = start.cloneNode();
            end.setAttribute("placeholder", "Max");

            start.addEventListener("change", buildValues);
            start.addEventListener("blur", buildValues);
            start.addEventListener("keydown", keypress);

            end.addEventListener("change", buildValues);
            end.addEventListener("blur", buildValues);
            end.addEventListener("keydown", keypress);


            container.appendChild(start);
            container.appendChild(end);

            return container;
        }

        let iconDelete = function (cell, formatterParams) { //plain text value
            return "<i class='fa fa-trash-can'></i>";
        };


        let tableMachine = new DataTable('#tableMachine', {
            info: false,
            filter: false,
            ajax: '{% url 'apps:get_all_machines_in_table' %}',
            columns: [
                {data: null, width: '5%'},
                {data: 'matriculate'},
                {data: 'model'},
            ],
            select: true,
            createdRow: function (row, data, dataIndex) {
                tableMachine.rows().every(function (idx) {
                    $(this.node()).find('td').eq(0).html(idx + 1);
                });
            },
        });


        let tickCrossEditor = function (cell, onRendered, success, cancel) {
            // Create the checkbox element
            let checkbox = document.createElement("input");
            checkbox.type = "checkbox";

            // Get the current value of the cell
            let currentValue = cell.getValue();

            // Check if both matriculate and model fields are not empty
            let canTick = cell.getRow().getData().matriculate;

            // Set the checkbox state based on the current value and allowed state
            checkbox.checked = currentValue === true && canTick;
            checkbox.disabled = !canTick;

            // Handle checkbox change event
            checkbox.addEventListener("change", function () {
                if (canTick) {
                    success(checkbox.checked);
                } else {
                    // If not allowed to tick, reset the checkbox and show an alert
                    checkbox.checked = false;
                    alert("Please fill in 'Matriculate' and 'Model' fields before marking.");
                }
            });

            onRendered(function () {
                cell.getElement().appendChild(checkbox);
            });

            return checkbox;
        };

        let headerPopupFormatter = function (e, column, onRendered) {
            let container = document.createElement("div");

            let label = document.createElement("label");
            label.innerHTML = "Filtre Colonne:";
            label.style.display = "block";
            label.style.fontSize = ".7em";

            let input = document.createElement("input");
            input.placeholder = "Chercher ...";
            input.value = column.getHeaderFilterValue() || "";

            input.addEventListener("keyup", (e) => {
                column.setHeaderFilterValue(input.value);
            });

            container.appendChild(label);
            container.appendChild(input);

            return container;
        }

        let emptyHeaderFilter = function () {
            return document.createElement("div");
        }

        let addRow = function () {
            let newRowData = {};
            table.addRow(newRowData, false);
        }

        function sendSelectedRows() {
            let editedCells = table.getEditedCells();
            let selectedRowsData = editedCells.filter(cell => {
                let rowData = cell.getRow().getData();
                return cell.getColumn().getField() === "tickCross" && rowData.tickCross === true;
            }).map(cell => cell.getRow().getData());
            console.log(selectedRowsData)
            fetch("", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(selectedRowsData)
            }).then(response => response.json())
                .then(data => {
                    // Handle the response from the backend (success/failure)
                    console.log("AJAX POST response:", data);
                })
                .catch(error => {
                    console.error("AJAX POST error:", error);
                });
        }

        function uniqueCellFormatter(cell) {
            let data = table.getData(); // Get all table data
            let value = cell.getValue();

            // Check if the value is unique
            let isUnique = data.every(row => row.matriculate !== value || row === cell.getRow());

            if (!isUnique) {
                // Set a red border if the value is not unique
                return {
                    border: "2px solid red"
                };
            }

            // No border by default
            return {};
        }


        function reloadPage() {
            window.reload()
        }

        function formatDate(dateString) {
            if (dateString && dateString.trim() !== '') { // Vérifiez si dateString est une chaîne non vide
                const [day, month, year] = dateString.split('/');
                // Si votre date est au format DD/MM/YYYY, vous pouvez la reformater en YYYY-MM-DD
                return `${year}-${month}-${day}`;
            }
            return null; // Renvoyer null si la date est vide ou non valide
        }

        function calculImmo(cell) {
            const rowData = cell.getRow().getData();

            const formattedStartDate = formatDate(rowData.start);

            if (formattedStartDate) {
                const startDate = new Date(formattedStartDate);
                if (isNaN(startDate.getTime())) {
                    return "";
                }

                // Calculer la différence en jours
                const today = new Date();
                const diffInMs = today.getTime() - startDate.getTime();

                return Math.floor(diffInMs / (1000 * 60 * 60 * 24));
            }
            return ''

        }

        function calculImmoReel(cell) {
            const rowData = cell.getRow().getData();

            const formattedStartDate = formatDate(rowData.start);
            const formattedEndDate = formatDate(rowData.leave);

            if (formattedStartDate && formattedEndDate) {
                const startDate = new Date(formattedStartDate);
                const endDate = new Date(formattedEndDate);
                if (isNaN(startDate.getTime())) {
                    return "";
                }
                if (isNaN(endDate.getTime())) {
                    return "";
                }

                const diffInMs = endDate.getTime() - startDate.getTime();

                return Math.floor(diffInMs / (1000 * 60 * 60 * 24)) + 1;
            }
            return ''

        }

        function stateLine(cell, formatterParams) {
            let rowData = cell.getRow().getData();
            let rowStart = rowData.start;
            let rowLeave = rowData.leave;

            if (rowStart) {
                if (rowLeave) {
                    return 'Active';
                } else {
                    return 'Inactive';
                }
            } else {
                return '';
            }

        }

        let table = new Tabulator("#pannes", {
            ajaxURL: "{% url 'apps:get_breakdown' %}",
            ajaxContentType: "json",
            layout: "fitDataFill",
            printAsHtml: true,
            printHeader: "<h1>Example Table Header<h1>",
            printFooter: "<h2>Example Table Footer<h2>",
            footerElement: `<button type='button' class='btn btn-success btn-sm mr-2' id="openModalBtn"><i class='fas fa-map-location'></i></button><button type='button' class='btn btn-warning btn-sm mr-2' id='reload-table' onClick="reloadPage()"><i class='fas fa-sync-alt'></i></button>`,
            tooltipsHeader: true,
            rowFormatter: function (row) {
                const rowData = row.getData();
                const start = rowData.start;
                const leave = rowData.leave;

                if (start) {
                    if (leave) {
                        row.getElement().style.backgroundColor = "#1e3b20"; // Add 'active-row' class

                    } else {
                        row.getElement().style.backgroundColor = "#3b1e2b"; //
                    }
                }
            },
            rowHeader: {
                title: `<button type='button' class='btn btn-primary btn-sm mr-2' id='add-row' onclick="addRow()"><i class='fas fa-plus'></i></button>`,
                headerSort: false,
                resizable: false,
                minWidth: 30,
                width: 35,
                frozen: true,
                rowHandle: true,
                editor: false,
                formatter: "handle",
            },
            movableRows: true,
            history: true,
            success: function (data) {
                const breakdowns = data.data;
                table.setData(breakdowns);
            },
            selectableRangeColumns: true,
            selectableRangeRows: true,
            headerSortClickElement: 'icon',
            selectableRangeClearCells: true,
            pagination: "local",
            columnHeaderVertAlign: "bottom",
            paginationSize: 10,
            paginationSizeSelector: [20, 30, 40],
            paginationCounter: "rows",
            renderHorizontal: "virtual",
            resizableColumnFit: true,
            resizableRowGuide: true,
            resizableColumnGuide: true,
            editTriggerEvent: "dblclick",
            printRowRange: "selected",
            initialSort: [
                {column: "matriculate", dir: "asc"},
            ],
            placeholder: "Aucun Donnée",
            placeholderHeaderFilter: 'Aucun Donnée Correspondent',
            headerSort: true,
            columnDefaults: {
                tooltip: true,
                headerHozAlign: "center",
                editor: "input",
                resizable: "header",
            },
            columns: [
                {
                    title: "<code>*</code>",
                    frozen: true,
                    resizable: false,
                    hozAlign: "center",
                    formatter: "tickCross",
                    editor: tickCrossEditor,
                    headerSort: false,
                    cellEdited: function (cell) {
                        let edited = cell.isEdited();
                        if (edited) {
                            let conf = confirm("Est-vous sûr de vouloir enregistrer ce ligne ?")
                            if (conf) {
                                const rowData = cell.getRow().getData();
                                console.log(rowData)
                                if (rowData.uid) {
                                    // Update existing breakdown using apps:update_line
                                    fetch("{% url 'apps:update_line' %}", {
                                        method: "POST",
                                        headers: {
                                            "Content-Type": "application/json"
                                        },
                                        body: JSON.stringify(rowData)
                                    })
                                        .then(response => response.json())
                                        .then(data => {
                                            if (data.success) {
                                                cell.getRow().update(rowData);
                                            }
                                        })
                                        .catch(error => {
                                            console.error("Error updating breakdown:", error);
                                        });
                                } else {
                                    fetch("{% url 'apps:post_line' %}", {
                                        method: "POST",
                                        headers: {
                                            "Content-Type": "application/json"
                                        },
                                        body: JSON.stringify(rowData)
                                    })
                                        .then(response => {
                                            if (response.status === 409) {
                                                return response.json().then(data => {
                                                    alert(data.error);
                                                    location.reload();
                                                });
                                            }
                                            return response.json(); // Parser la réponse JSON pour les requêtes réussies
                                        })

                                }
                            }
                        }
                    }
                },
                {
                    title: "N°",
                    resizable: false,
                    formatter: "rownum",
                    hozAlign: "center",
                    width: 40,
                    editor: false,
                    frozen: true,
                    headerSort: false,
                },
                {
                    title: "ID Rental",
                    columns: [
                        {
                            title: "<code>*</code> Immat ou N° série ",
                            field: "matriculate",
                            width: 125,
                            frozen: true,
                            editor: "list",
                            editorParams: {
                                placeholderEmpty: "Aucun Matricule",
                                sort: "asc",
                                valuesURL: "{% url 'apps:get_all_matriculate' %}",
                                placeholderLoading: "Chargement...",

                            },
                            headerPopupIcon: "<i class='fas fa-filter' title='Filter column'></i>",
                            headerFilter: emptyHeaderFilter,
                            headerPopup: headerPopupFormatter,
                            headerFilterFunc: "like",
                        },
                        {
                            title: "Modèle / Remorque",
                            field: "model",
                            editor: "input",
                            frozen: true,
                            width: 125,
                        },
                        {
                            title: "CLIENT",
                            field: "client_name",
                            width: 150,
                            editor: "input",
                        },
                        {
                            title: "Localisation",
                            field: "localisation_name",
                            editor: "list",
                            hozAlign: 'right',
                            validator: "required",
                            editorParams: {
                                placeholderEmpty: "Aucun Localisation",
                                autocomplete: "true", allowEmpty: true, listOnEmpty: true,
                                valuesURL: "{% url 'apps:gat_all_localisation' %}",
                                placeholderLoading: "Chargement...",

                                formatter: function (value, data, cell) {
                                    if (value && value.label) {
                                        return value.label;  // Access and return the label from the value object
                                    } else {
                                        return "";
                                    }
                                }
                            },
                        },
                        {
                            title: "Début panne",
                            hozAlign: "right",
                            field: "start",
                            sorter: "datetime",
                            width: 100,
                            editor: "datetime",
                             editorParams: {
                                format: "dd/MM/yyyy HH:mm:ss",
                                verticalNavigation: "table", 
                            }
                        },
                        {
                            title: "Demande rdv",
                            field: "appointment",
                            sorter: "datetime",
                            width: 100,
                            editor: "datetime",
                             editorParams: {
                                format: "dd/MM/yyyy HH:mm:ss",
                                verticalNavigation: "table", 
                            }


                        },
                        {
                            title: "Entrée garage",
                            field: "enter",
                            sorter: "datetime",
                            width: 100,
                            editor: "datetime",
                            editorParams: {
                                format: "dd/MM/yyyy HH:mm:ss",
                                verticalNavigation: "table", 
                            }
                        },
                        {
                            title: "DEMANDE DE TRAVAUX",
                            field: "works",
                            editor: textareaPopup,
                            width: 200,
                            formatter: function (cell, formatterParams) {
                                // Get the value from the cell
                                const value = cell.getValue();

                                // Use DOMPurify to sanitize the HTML content (optional but recommended for security)
                                const cleanText = DOMPurify.sanitize(value);

                                // Create a temporary element to remove HTML tags
                                const tempElement = document.createElement('div');
                                tempElement.textContent = cleanText;

                                // Return the plain text content
                                return tempElement.textContent;
                            },
                            editorParams: {
                                selectContents: true,
                                verticalNavigation: "editor",
                                shiftEnterSubmit: true,
                                maskAutoFill: true,

                            },
                        },
                        {
                            title: "Date de sortie du garage",
                            field: "leave",
                            sorter: "datetime",
                            width: 100,
                            editor: "datetime",
                            editorParams: {
                                format: "dd/MM/yyyy HH:mm:ss", // the format of the date value stored in the cell
                                verticalNavigation: "table", //navigate cursor around table without changing the value

                            }
                        },
                        {
                            title: "Km/H Entrée Garage",
                            field: '',
                            editor: false,
                            width: 100
                        },
                        {
                            title: "Km/H Sortie Garage",
                            field: '',
                            editor: false,
                            width: 100
                        },
                    ]
                },
                {
                    title: "Nb Jours Immo",
                    width: 100,
                    editor: false,
                    hozAlign: "right",
                    formatter: calculImmo,
                },
                {
                    title: "SAV ID Motors",
                    columns: [
                        {
                            title: "N° OR (ordre de réparation)",
                            hozAlign: "right",
                            field: "order",
                            width: 100,
                            editor: "number",
                            editorParams: {
                                min: 0,
                                max: 100,
                                elementAttributes: {
                                    maxlength: "10", //set the maximum character length of the input element to 10 characters
                                },
                                mask: "999",
                                selectContents: true,
                                verticalNavigation: "table", //up and down arrow keys navigate away from cell without changing value
                            }
                        },
                        {
                            title: "ETAT PIECES REF",
                            field: "piece",
                            editor: textareaPopup,
                            width: 200,
                            formatter: function (cell, formatterParams) {
                                // Get the value from the cell
                                const value = cell.getValue();

                                // Use DOMPurify to sanitize the HTML content (optional but recommended for security)
                                const cleanText = DOMPurify.sanitize(value);

                                // Create a temporary element to remove HTML tags
                                const tempElement = document.createElement('div');
                                tempElement.textContent = cleanText;

                                // Return the plain text content
                                return tempElement.textContent;
                            },
                        },
                        {
                            title: 'DIAGNOSTICS/TRAVAUX EFFECTUER AUX ATELIER & COMMENTAIRES SAV',
                            field: 'diagnostics',
                            editor: textareaPopup,
                            width: 200,
                            formatter: function (cell, formatterParams) {
                                // Get the value from the cell
                                const value = cell.getValue();

                                // Use DOMPurify to sanitize the HTML content (optional but recommended for security)
                                const cleanText = DOMPurify.sanitize(value);

                                // Create a temporary element to remove HTML tags
                                const tempElement = document.createElement('div');
                                tempElement.textContent = cleanText;

                                // Return the plain text content
                                return tempElement.textContent;
                            },
                            editorParams: {
                                selectContents: true,
                                verticalNavigation: "editor",
                                shiftEnterSubmit: true,
                                maskAutoFill: true,
                            },
                        },
                        {
                            title: "Date prévisionnelle de sortie garage",
                            field: "prevision",
                            editor: textareaPopup,
                            width: 200,
                            formatter: function (cell, formatterParams) {
                                // Get the value from the cell
                                const value = cell.getValue();

                                // Use DOMPurify to sanitize the HTML content (optional but recommended for security)
                                const cleanText = DOMPurify.sanitize(value);

                                // Create a temporary element to remove HTML tags
                                const tempElement = document.createElement('div');
                                tempElement.textContent = cleanText;

                                // Return the plain text content
                                return tempElement.textContent;
                            },
                            editorParams: {
                                selectContents: true,
                                verticalNavigation: "editor",
                                shiftEnterSubmit: true,
                                maskAutoFill: true,
                            },
                        },
                    ]
                },
                {
                    title: "Achat et Import ID Motors",
                    columns: [
                        {
                            title: 'COMMENTAIRES ACHATS',
                            field: 'achats',
                            editor: textareaPopup,
                            width: 200,
                            formatter: function (cell, formatterParams) {
                                // Get the value from the cell
                                const value = cell.getValue();

                                // Use DOMPurify to sanitize the HTML content (optional but recommended for security)
                                const cleanText = DOMPurify.sanitize(value);

                                // Create a temporary element to remove HTML tags
                                const tempElement = document.createElement('div');
                                tempElement.textContent = cleanText;

                                // Return the plain text content
                                return tempElement.textContent;
                            },
                            editorParams: {
                                selectContents: true,
                                verticalNavigation: "editor",
                                shiftEnterSubmit: true,
                                maskAutoFill: true,
                            },
                        },
                        {
                            title: 'COMMENTAIRES IMPORT',
                            field: 'imports',
                            editor: textareaPopup,
                            width: 200,
                            formatter: function (cell, formatterParams) {
                                // Get the value from the cell
                                const value = cell.getValue();

                                // Use DOMPurify to sanitize the HTML content (optional but recommended for security)
                                const cleanText = DOMPurify.sanitize(value);

                                // Create a temporary element to remove HTML tags
                                const tempElement = document.createElement('div');
                                tempElement.textContent = cleanText;

                                // Return the plain text content
                                return tempElement.textContent;
                            },
                            editorParams: {
                                selectContents: true,
                                verticalNavigation: "editor",
                                shiftEnterSubmit: true,
                                maskAutoFill: true,
                            },
                        },
                    ]
                },
                {
                    title: "Nb Jours Immo Réelle",
                    width: 100,
                    editor: false,
                    hozAlign: "right",
                    formatter: calculImmoReel,
                },
                {
                    title: "Actif / Non Actif",
                    width: 100,
                    editor: false,
                    hozAlign: "center",
                    formatter: stateLine,
                    formatterParams: { // Define properties for conditional formatting
                        activeBackgroundColor: "#90EE90", // Light green
                        inactiveBackgroundColor: "#FFCDD2" // Light red
                    }
                },
                {
                    title: "DECISION",
                    field: "decision",
                    editor: textareaPopup,
                    width: 200,
                    formatter: function (cell, formatterParams) {
                        // Get the value from the cell
                        const value = cell.getValue();

                        // Use DOMPurify to sanitize the HTML content (optional but recommended for security)
                        const cleanText = DOMPurify.sanitize(value);

                        // Create a temporary element to remove HTML tags
                        const tempElement = document.createElement('div');
                        tempElement.textContent = cleanText;

                        // Return the plain text content
                        return tempElement.textContent;
                    },
                },
                {
                    formatter: iconDelete,
                    headerSort: false,
                    frozen: true,
                    resizable: false,
                    hozAlign: "center",
                    cellClick: function (e, cell) {
                        console.log(cell.getData().uid)

                        let breakdownId = cell.getData().uid;
                        if (breakdownId) {
                            if (confirm("Est-vous sûr de vouloir supprimer ceci ?")) {

                                fetch("{% url 'apps:delete_breakdown' %}", {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/x-www-form-urlencoded",
                                        "X-CSRFToken": "{{ csrf_token }}"
                                    },
                                    body: "breakdown_id=" + breakdownId
                                })
                                    .then(response => response.json())
                                    .then(data => {
                                        if (data.success) {
                                            table.deleteRow(cell.getRow());

                                        } else {
                                            console.error("Error deleting Breakdown:", data.error);
                                        }
                                    })
                                    .catch(error => {
                                        console.error("Error deleting Breakdown:", error);
                                    });
                            }

                        } else {
                            table.deleteRow(cell.getRow());
                        }
                    }
                }
            ],
        });

        document.getElementById("download-xlsx").addEventListener("click", function () {
            table.download("xlsx", "data.xlsx", {sheetName: "My Data"});
        });


        document.getElementById("print-table").addEventListener("click", function () {
            table.print(false, true);
        });

        //trigger download of data.pdf file
        document.getElementById("download-pdf").addEventListener("click", function () {
            table.download("pdf", "data.pdf", {
                orientation: "portrait", //set page orientation to portrait
                title: "Example Report", //add title to report
            });
        });


        table.on("rowMoved", function (row) {
            console.log("Row: " + row.getData().matriculate + " has been moved");
        });

        //undo button
        document.getElementById("history-undo").addEventListener("click", function () {
            table.undo();
        });

        //redo button
        document.getElementById("history-redo").addEventListener("click", function () {
            table.redo();
        });

        document.addEventListener('DOMContentLoaded', function () {
            try {
                document.getElementById('openModalBtn').addEventListener('click', function () {
                    let myModal = new bootstrap.Modal(document.getElementById('chartModal'));
                    myModal.show();


                    fetch('{% url 'apps:get_all_breakdown' %}')
                        .then(response => response.json())
                        .then(data => {
                            console.log(data)
                            Highcharts.mapChart('container-map', {
                                chart: {
                                    margin: 0
                                },

                                title: {
                                    text: ''
                                },

                                subtitle: {
                                    text: ''
                                },

                                navigation: {
                                    buttonOptions: {
                                        align: 'left',
                                        theme: {
                                            stroke: '#e6e6e6'
                                        }
                                    }
                                },

                                mapNavigation: {
                                    enabled: true,
                                    buttonOptions: {
                                        alignTo: 'spacingBox'
                                    }
                                },

                                mapView: {
                                    center: [46.3927, -18.6174],
                                    zoom: 7
                                },

                                tooltip: {
                                    pointFormat: '{point.name}'
                                },

                                legend: {
                                    enabled: true,
                                    title: {
                                        text: 'Map Engin en Pane'
                                    },
                                    align: 'left',
                                    symbolWidth: 20,
                                    symbolHeight: 20,
                                    itemStyle: {
                                        textOutline: '1 1 1px rgba(255,255,255)'
                                    },
                                    backgroundColor: 'rgba(255,255,255,0.8)',
                                    float: true,
                                    borderColor: '#e6e6e6',
                                    borderWidth: 1,
                                    borderRadius: 2,
                                    itemMarginBottom: 5
                                },

                                plotOptions: {
                                    mappoint: {
                                        dataLabels: {
                                            enabled: false
                                        }
                                    }
                                },
                                series: data
                            });
                        })
                        .catch(error => console.error('Erreur lors de la récupération des données :', error));
                });
            } catch (e) {

            }

        });

        window.addEventListener('resize', function () {
            table.redraw();
        });

    </script>
{% endblock %}